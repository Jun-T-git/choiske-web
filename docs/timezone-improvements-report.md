# タイムゾーン処理改善レポート

## 概要

Choiske Web アプリケーションにおけるタイムゾーン処理の問題を特定し、一貫性のあるタイムゾーン処理を実装するための改善を行いました。具体的には、サーバー/DB 側では UTC、クライアント表示では JST（日本時間）という標準パターンを確立し、アプリケーション全体でこのパターンが一貫して適用されるようにしました。

## 実施した変更

1. **Utils 関数の拡充** (`/src/lib/utils/dateUtils.ts`)

   - UTC/JST 変換のためのユーティリティ関数セットを追加
   - ISO 文字列の検証関数を追加
   - 既存関数との連携を確保

2. **コンポーネントの改善**

   - `GuestSummaryTable.tsx`: 日付表示にタイムゾーン変換を追加
   - `SlotStatusTable.tsx`: 明示的なタイムゾーン変換処理を追加
   - `ScheduleForm.tsx`: 初期データのタイムゾーン変換を正しく処理

3. **タイムゾーン表示の明示化**

   - `TimezoneIndicator` コンポーネントの作成
   - 日付/時間を表示する主要コンポーネントにインジケーターを追加

4. **テストとドキュメントの整備**
   - タイムゾーン変換のための統合テストを作成
   - プロジェクト全体で一貫したタイムゾーン処理のガイドラインを文書化

## 変更したファイル

1. `/src/lib/utils/dateUtils.ts` - タイムゾーン変換ユーティリティの追加
2. `/src/tests/unit/lib/utils/dateUtils.test.ts` - ユーティリティのテスト拡充
3. `/src/components/organisms/guest/GuestSummaryTable.tsx` - 表示時のタイムゾーン変換追加
4. `/src/components/organisms/guest/SlotStatusTable.tsx` - タイムゾーンインジケーター追加
5. `/src/components/templates/ScheduleForm.tsx` - 初期データ変換とタイムゾーン表示改善
6. `/src/components/atoms/TimezoneIndicator.tsx` - 新規コンポーネント作成
7. `/src/tests/unit/lib/utils/timezone-integration.test.ts` - 統合テスト追加
8. `/docs/timezone-practices.md` - タイムゾーン処理ガイドライン作成

## 検証方法

1. 日付選択と表示が一貫して JST で行われることを確認
2. API リクエスト/レスポンスが適切に UTC で処理されることを確認
3. 日付が 1 日ずれるなどの問題がないことを確認
4. タイムゾーンインジケーターが適切に表示されていることを確認

## 今後の課題

1. **E2E テストの追加**: さまざまなタイムゾーン環境でのテスト自動化
2. **サーバーサイドのロギング強化**: タイムゾーン関連の問題を特定しやすくする
3. **ユーザー向けタイムゾーン設定**: 将来的に複数タイムゾーンのサポートを検討
4. **パフォーマンス最適化**: タイムゾーン変換のオーバーヘッドを最小化

## 学び

1. タイムゾーン処理は常に明示的に行い、暗黙的な変換に頼らないこと
2. フロントエンドとバックエンドの間で一貫したタイムゾーン規約を確立することの重要性
3. ユーザーに対してタイムゾーン情報を明示することの重要性
4. 国際的なアプリケーションでのタイムゾーン処理のベストプラクティス
